name: Copilot Auto Implementation

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  auto-implement:
    # ç‰¹å®šã®ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸ Issue ã®ã¿å®Ÿè¡Œ
    if: contains(github.event.issue.labels.*.name, 'auto-implement')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create feature branch
        id: create-branch
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          BRANCH_NAME="feature/issue-${ISSUE_NUMBER}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: GitHub Copilot Implementation
        id: copilot-impl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Issue ã®å†…å®¹ã‚’è§£æã—ã¦å®Ÿè£…
          # ã“ã“ã§ã¯ç°¡å˜ãªä¾‹ã¨ã—ã¦ã€è¨˜äº‹è¿½åŠ ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…
          
          # Issueæœ¬æ–‡ã‹ã‚‰è¨˜äº‹æƒ…å ±ã‚’æŠ½å‡ºï¼ˆä¾‹: "æ—¥ä»˜: 12/8\nã‚¿ã‚¤ãƒˆãƒ«: xxx\nURL: https://..."ï¼‰
          echo "Processing issue: $ISSUE_TITLE"
          echo "$ISSUE_BODY" > issue_content.txt
          
          # å®Ÿè£…ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆNode.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¨˜äº‹ã‚’è¿½åŠ ï¼‰
          node << 'EOF'
          const fs = require('fs');
          const issueContent = fs.readFileSync('issue_content.txt', 'utf8');
          
          // Issueæœ¬æ–‡ã‹ã‚‰æ—¥ä»˜ã€ã‚¿ã‚¤ãƒˆãƒ«ã€URLã‚’æŠ½å‡º
          const dateMatch = issueContent.match(/æ—¥ä»˜[ï¼š:]\s*(\d{1,2})\/(\d{1,2})/);
          const titleMatch = issueContent.match(/ã‚¿ã‚¤ãƒˆãƒ«[ï¼š:]\s*(.+)/);
          const urlMatch = issueContent.match(/URL[ï¼š:]\s*(https?:\/\/[^\s]+)/);
          
          if (dateMatch && titleMatch && urlMatch) {
            const day = parseInt(dateMatch[2]);
            const title = titleMatch[1].trim();
            const url = urlMatch[1].trim();
            
            // articles.js ã‚’èª­ã¿è¾¼ã‚“ã§æ›´æ–°
            const articlesPath = './src/constants/articles.js';
            let content = fs.readFileSync(articlesPath, 'utf8');
            
            // æ–°ã—ã„è¨˜äº‹ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆ
            const newEntry = `  ${day}: {\n    title: "${title}",\n    url: "${url}"\n  }`;
            
            // ARTICLES ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æœ€å¾Œã«è¿½åŠ 
            const insertPos = content.lastIndexOf('}');
            const beforeClose = content.substring(0, insertPos).trimEnd();
            const hasExistingEntries = beforeClose.match(/\d+:\s*{/);
            
            if (hasExistingEntries) {
              // æ—¢å­˜ã®ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚‹å ´åˆã¯ã‚«ãƒ³ãƒã‚’è¿½åŠ 
              content = beforeClose + ',\n' + newEntry + '\n' + content.substring(insertPos);
            } else {
              // æœ€åˆã®ã‚¨ãƒ³ãƒˆãƒªã®å ´åˆ
              content = beforeClose + '\n' + newEntry + '\n' + content.substring(insertPos);
            }
            
            fs.writeFileSync(articlesPath, content);
            console.log(`Added article for day ${day}: ${title}`);
            
            // å®Ÿè£…å†…å®¹ã‚’ã‚µãƒãƒªãƒ¼ã«å‡ºåŠ›
            fs.writeFileSync('implementation_summary.txt', 
              `Day ${day}ã®è¨˜äº‹ã‚’è¿½åŠ ã—ã¾ã—ãŸ\nã‚¿ã‚¤ãƒˆãƒ«: ${title}\nURL: ${url}`);
          } else {
            console.log('Could not parse issue content. Please use format:\næ—¥ä»˜: MM/DD\nã‚¿ã‚¤ãƒˆãƒ«: xxx\nURL: https://...');
            fs.writeFileSync('implementation_summary.txt', 'Issue ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
            process.exit(1);
          }
          EOF
      
      - name: Commit and push changes
        id: commit
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Auto-implement: ${{ github.event.issue.title }} (#${{ github.event.issue.number }})"
            git push origin ${{ steps.create-branch.outputs.branch_name }}
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SUMMARY=$(cat implementation_summary.txt || echo "è‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸ")
          
          gh pr create \
            --title "Auto-implement: ${{ github.event.issue.title }}" \
            --body "Closes #${{ github.event.issue.number }}

          ## å®Ÿè£…å†…å®¹
          $SUMMARY

          ---
          ã“ã®PRã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚" \
            --base main \
            --head ${{ steps.create-branch.outputs.branch_name }}
      
      - name: Comment on Issue
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = require('fs').readFileSync('implementation_summary.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ¤– è‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n${summary}\n\nPRã‚’ç¢ºèªã—ã¦ãã ã•ã„: #${context.issue.number}`
            });
