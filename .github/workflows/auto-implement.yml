name: Auto Implementation with GitHub Copilot

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  auto-implement:
    # 'auto-implement' ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸ Issue ã®ã¿å®Ÿè¡Œ
    if: contains(github.event.issue.labels.*.name, 'auto-implement')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Create feature branch
        id: create-branch
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          BRANCH_NAME="feature/issue-${ISSUE_NUMBER}"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
      
      - name: Implement with GitHub Models AI
        id: ai-implementation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "ğŸ¤– AIå®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™..." > implementation_log.txt
          
          # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åé›†
          echo "ğŸ“‚ ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ :" >> implementation_log.txt
          find src -type f -name "*.js" -o -name "*.jsx" -o -name "*.css" >> implementation_log.txt
          
          # GitHub Models APIã‚’ä½¿ç”¨ã—ã¦AIã«å®Ÿè£…ã‚’ä¾é ¼
          cat << 'PROMPT_EOF' > prompt.txt
          ã‚ãªãŸã¯Reacté–‹ç™ºè€…ã§ã™ã€‚ä»¥ä¸‹ã®Issueã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

          # Issue: ${{ github.event.issue.title }}
          
          ${{ github.event.issue.body }}

          # ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ 
          - React + Vite ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
          - src/constants/articles.js: è¨˜äº‹ãƒ‡ãƒ¼ã‚¿
          - src/components/: Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
          - Netlifyã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°

          # æŒ‡ç¤º
          1. Issueå†…å®¹ã‚’åˆ†æ
          2. å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç‰¹å®š
          3. å…·ä½“çš„ãªå®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
          4. ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª

          JSONå½¢å¼ã§ä»¥ä¸‹ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„:
          {
            "files": [
              {
                "path": "ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹",
                "action": "create/modify/delete",
                "content": "ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ï¼ˆmodify/createã®å ´åˆï¼‰"
              }
            ],
            "summary": "å®Ÿè£…å†…å®¹ã®ã‚µãƒãƒªãƒ¼"
          }
          PROMPT_EOF

          # GitHub Models APIå‘¼ã³å‡ºã—ï¼ˆgpt-4o ã¾ãŸã¯ claude-3.5-sonnetï¼‰
          RESPONSE=$(curl -s -X POST "https://models.github.com/v1/chat/completions" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"You are an expert React developer. Always respond in valid JSON format.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": $(cat prompt.txt | jq -Rs .)
                }
              ],
              \"temperature\": 0.3
            }")
          
          echo "$RESPONSE" > ai_response.json
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰JSONã‚’æŠ½å‡º
          AI_CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          echo "$AI_CONTENT" > implementation_plan.json
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè£…
          node << 'NODE_EOF'
          const fs = require('fs');
          const path = require('path');
          
          try {
            // AIå¿œç­”ã‚’èª­ã¿è¾¼ã¿
            let planText = fs.readFileSync('implementation_plan.json', 'utf8');
            
            // JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºï¼ˆ```json ... ``` ã®å ´åˆã«å¯¾å¿œï¼‰
            const jsonMatch = planText.match(/```json\s*([\s\S]*?)\s*```/) || planText.match(/```\s*([\s\S]*?)\s*```/);
            if (jsonMatch) {
              planText = jsonMatch[1];
            }
            
            const plan = JSON.parse(planText);
            let summary = [];
            
            if (plan.files && Array.isArray(plan.files)) {
              for (const file of plan.files) {
                const filePath = file.path;
                const dir = path.dirname(filePath);
                
                // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
                if (!fs.existsSync(dir)) {
                  fs.mkdirSync(dir, { recursive: true });
                }
                
                if (file.action === 'create' || file.action === 'modify') {
                  fs.writeFileSync(filePath, file.content);
                  summary.push(`${file.action === 'create' ? 'âœ… ä½œæˆ' : 'âœï¸ æ›´æ–°'}: ${filePath}`);
                } else if (file.action === 'delete' && fs.existsSync(filePath)) {
                  fs.unlinkSync(filePath);
                  summary.push(`ğŸ—‘ï¸ å‰Šé™¤: ${filePath}`);
                }
              }
            }
            
            // ã‚µãƒãƒªãƒ¼ã‚’ä¿å­˜
            const logContent = [
              'ğŸ¤– AIå®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸ',
              '',
              '## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«',
              ...summary,
              '',
              '## å®Ÿè£…å†…å®¹',
              plan.summary || 'Issueå†…å®¹ã«åŸºã¥ã„ã¦å®Ÿè£…ã—ã¾ã—ãŸ'
            ].join('\n');
            
            fs.writeFileSync('implementation_log.txt', logContent);
            console.log(logContent);
            
          } catch (error) {
            const errorLog = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}\n\nAIå¿œç­”ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•å®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚`;
            fs.writeFileSync('implementation_log.txt', errorLog);
            console.error(errorLog);
            process.exit(0); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶šè¡Œï¼ˆç©ºã‚³ãƒŸãƒƒãƒˆã§å¯¾å¿œï¼‰
          }
          NODE_EOF
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸ¤– Auto-implement: ${{ github.event.issue.title }}"
          else
            # å¤‰æ›´ãŒãªã„å ´åˆã¯ç©ºã‚³ãƒŸãƒƒãƒˆ
            git commit --allow-empty -m "chore: AI implementation attempted for issue #${{ github.event.issue.number }}"
          fi
      
      - name: Push branch
        run: |
          git push origin ${{ steps.create-branch.outputs.branch_name }}
      
      - name: Create Pull Request
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LOG_CONTENT=$(cat implementation_log.txt)
          
          PR_URL=$(gh pr create \
            --title "ğŸ¤– Auto: ${{ github.event.issue.title }}" \
            --body "Closes #${{ github.event.issue.number }}

          ## ğŸ“‹ Issueå†…å®¹
          ${{ github.event.issue.body }}

          ---

          ## ğŸ¤– AIå®Ÿè£…çµæœ
          $(cat implementation_log.txt)

          ---

          ## ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
          - å®Ÿè£…å†…å®¹ãŒIssueã®è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ç¢ºèª
          - ã‚³ãƒ¼ãƒ‰ã®å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã£ã¦ã„ã‚‹ã‹ç¢ºèª
          - Netlify Deploy Previewã§å‹•ä½œç¢ºèª

          å•é¡ŒãŒã‚ã‚Œã°è¿½åŠ ã§ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã‹ã€æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

          ---
          _ã“ã®PRã¯GitHub Models AIã«ã‚ˆã‚Šè‡ªå‹•å®Ÿè£…ã•ã‚Œã¾ã—ãŸ_" \
            --base main \
            --head ${{ steps.create-branch.outputs.branch_name }})
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "$PR_URL" > pr_url.txt
      
      - name: Add labels to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ steps.create-pr.outputs.pr_url }} --add-label "auto-generated"
      
      - name: Comment on Issue with instructions
        uses: actions/github-script@v7
        with:
          script: |
            const prUrl = require('fs').readFileSync('pr_url.txt', 'utf8').trim();
            const prNumber = prUrl.split('/').pop();
            
            const logContent = require('fs').readFileSync('implementation_log.txt', 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ¤– **AIè‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼**

            ## ğŸ“ ä½œæˆã•ã‚ŒãŸPR
            ${prUrl}

            ## ğŸ¯ å®Ÿè£…çµæœ
            \`\`\`
            ${logContent}
            \`\`\`

            ## ğŸ” æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. PRã®Netlify Deploy Previewã§å‹•ä½œç¢ºèª
            2. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
            3. å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸

            AIãŒæ­£ã—ãå®Ÿè£…ã§ããªã‹ã£ãŸå ´åˆã¯ã€ä»¥ä¸‹ã§æ‰‹å‹•ä¿®æ­£ã§ãã¾ã™:
            \`\`\`bash
            git fetch origin
            git checkout ${{ steps.create-branch.outputs.branch_name }}
            # ä¿®æ­£ä½œæ¥­
            git push
            \`\`\`

            ---
            ğŸ’¡ ã“ã®Issueã¯GitHub Models AIã«ã‚ˆã‚Šè‡ªå‹•å®Ÿè£…ã•ã‚Œã¾ã—ãŸ`
            });
      
      - name: Update Issue with workflow link
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: [...context.payload.issue.labels.map(l => l.name), 'in-progress']
            });
