name: Auto Implementation with GitHub Copilot

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  auto-implement:
    # 'auto-implement' ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸ Issue ã®ã¿å®Ÿè¡Œ
    if: contains(github.event.issue.labels.*.name, 'auto-implement')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Create feature branch
        id: create-branch
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          BRANCH_NAME="feature/issue-${ISSUE_NUMBER}"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
      
      - name: Trigger Copilot Workspace (Placeholder)
        id: copilot-workspace
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "Issue #$ISSUE_NUMBER: $ISSUE_TITLE" > implementation_log.txt
          echo "---" >> implementation_log.txt
          echo "$ISSUE_BODY" >> implementation_log.txt
          echo "" >> implementation_log.txt
          echo "âš ï¸ GitHub Copilot Workspaceçµ±åˆã¯æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ãŒå¿…è¦ã§ã™" >> implementation_log.txt
          echo "ã“ã®PRã‚’Copilot Workspaceã§é–‹ã„ã¦å®Ÿè£…ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„" >> implementation_log.txt
          
          # ç©ºã®ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆã—ã¦ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git commit --allow-empty -m "chore: setup branch for issue #$ISSUE_NUMBER"
      
      - name: Push branch
        run: |
          git push origin ${{ steps.create-branch.outputs.branch_name }}
      
      - name: Create Pull Request
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LOG_CONTENT=$(cat implementation_log.txt)
          
          PR_URL=$(gh pr create \
            --title "ðŸ¤– Auto: ${{ github.event.issue.title }}" \
            --body "Closes #${{ github.event.issue.number }}

          ## ðŸ“‹ Issueå†…å®¹
          ${{ github.event.issue.body }}

          ---

          ## ðŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. ã“ã®PRã‚’[GitHub Copilot Workspace](https://githubnext.com/projects/copilot-workspace)ã§é–‹ã
          2. Issueå†…å®¹ã«åŸºã¥ã„ã¦Copilotã«å®Ÿè£…ã‚’ä¾é ¼
          3. ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
          4. å•é¡Œãªã‘ã‚Œã°ãƒžãƒ¼ã‚¸

          ã¾ãŸã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã“ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¦æ‰‹å‹•å®Ÿè£…:
          \`\`\`bash
          git fetch origin
          git checkout ${{ steps.create-branch.outputs.branch_name }}
          # å®Ÿè£…ä½œæ¥­
          git push
          \`\`\`

          ---
          _ã“ã®PRã¯GitHub Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ_" \
            --base main \
            --head ${{ steps.create-branch.outputs.branch_name }})
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "$PR_URL" > pr_url.txt
      
      - name: Add labels to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ steps.create-pr.outputs.pr_url }} --add-label "auto-generated"
      
      - name: Comment on Issue with instructions
        uses: actions/github-script@v7
        with:
          script: |
            const prUrl = require('fs').readFileSync('pr_url.txt', 'utf8').trim();
            const prNumber = prUrl.split('/').pop();
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ¤– **è‡ªå‹•å®Ÿè£…ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼**

            ## ðŸ“ ä½œæˆã•ã‚ŒãŸPR
            ${prUrl}

            ## ðŸš€ å®Ÿè£…æ–¹æ³•

            ### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: GitHub Copilot Workspaceï¼ˆæŽ¨å¥¨ï¼‰
            1. ä¸Šè¨˜PRã‚’[Copilot Workspace](https://githubnext.com/projects/copilot-workspace)ã§é–‹ã
            2. ã“ã®Issueã®å†…å®¹ã‚’Copilotã«ä¼ãˆã¦å®Ÿè£…ã‚’ä¾é ¼
            3. ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ã‚³ãƒŸãƒƒãƒˆ

            ### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
            \`\`\`bash
            git fetch origin
            git checkout ${{ steps.create-branch.outputs.branch_name }}
            # å®Ÿè£…ä½œæ¥­ã‚’è¡Œã†
            git add .
            git commit -m "Implement: ${{ github.event.issue.title }}"
            git push
            \`\`\`

            ### ã‚ªãƒ—ã‚·ãƒ§ãƒ³3: GitHub Copilot Chatï¼ˆVS Codeï¼‰
            1. VS Codeã§ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            2. Copilot Chatã§ã€Œ@workspace ã“ã®Issueã®å†…å®¹ã‚’å®Ÿè£…ã—ã¦: ${{ github.event.issue.title }}ã€
            3. ææ¡ˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã‚³ãƒŸãƒƒãƒˆ

            ---
            ðŸ’¡ å®Ÿè£…å®Œäº†å¾Œã€PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãƒžãƒ¼ã‚¸ã—ã¦ãã ã•ã„ï¼`
            });
      
      - name: Update Issue with workflow link
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: [...context.payload.issue.labels.map(l => l.name), 'in-progress']
            });
