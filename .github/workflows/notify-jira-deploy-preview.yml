name: Notify Jira with Netlify Deploy Preview

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: read

jobs:
  notify-jira:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Wait for Netlify Deploy Preview
        uses: actions/github-script@v7
        id: wait-netlify
        with:
          script: |
            const maxAttempts = 30; // æœ€å¤§5åˆ†å¾…æ©Ÿ
            const delay = 10000; // 10ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
            
            for (let i = 0; i < maxAttempts; i++) {
              // PRã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å–å¾—
              const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.payload.pull_request.head.sha
              });
              
              // Netlifyã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¢ã™
              const netlifyStatus = statuses.find(s => 
                s.context && s.context.includes('netlify') && s.target_url
              );
              
              if (netlifyStatus && netlifyStatus.state === 'success') {
                console.log(`Netlify Deploy Preview found: ${netlifyStatus.target_url}`);
                return netlifyStatus.target_url;
              }
              
              // Check deploymentsã‚‚ç¢ºèª
              const { data: deployments } = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.payload.pull_request.head.ref,
                per_page: 10
              });
              
              for (const deployment of deployments) {
                if (deployment.environment.includes('Preview')) {
                  const { data: deploymentStatuses } = await github.rest.repos.listDeploymentStatuses({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    deployment_id: deployment.id
                  });
                  
                  const successStatus = deploymentStatuses.find(s => 
                    s.state === 'success' && s.environment_url
                  );
                  
                  if (successStatus) {
                    console.log(`Deploy Preview found: ${successStatus.environment_url}`);
                    return successStatus.environment_url;
                  }
                }
              }
              
              console.log(`Attempt ${i + 1}/${maxAttempts}: Waiting for Netlify deploy...`);
              await new Promise(resolve => setTimeout(resolve, delay));
            }
            
            console.log('Netlify deploy preview not found within timeout');
            return null;
      
      - name: Extract Jira Issue Key from PR
        id: extract-jira
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const body = context.payload.pull_request.body || '';
            const branch = context.payload.pull_request.head.ref;
            
            // Jiraèª²é¡Œã‚­ãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä¾‹: PROJ-123, ABC-456ï¼‰
            const jiraKeyPattern = /([A-Z]+-\d+)/g;
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã€æœ¬æ–‡ã€ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰èª²é¡Œã‚­ãƒ¼ã‚’æŠ½å‡º
            const allText = `${title} ${body} ${branch}`;
            const matches = allText.match(jiraKeyPattern);
            
            if (matches && matches.length > 0) {
              const issueKey = matches[0];
              console.log(`Found Jira issue key: ${issueKey}`);
              return issueKey;
            }
            
            console.log('No Jira issue key found in PR');
            return null;
      
      - name: Post Deploy Preview to Jira
        if: steps.wait-netlify.outputs.result != 'null' && steps.extract-jira.outputs.result != 'null'
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          NETLIFY_URL: ${{ steps.wait-netlify.outputs.result }}
          JIRA_KEY: ${{ steps.extract-jira.outputs.result }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          if [ -z "$JIRA_BASE_URL" ] || [ -z "$JIRA_API_TOKEN" ] || [ -z "$JIRA_USER_EMAIL" ]; then
            echo "Jira credentials not configured. Skipping Jira comment."
            exit 0
          fi
          
          # Jira APIã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          curl -X POST \
            "${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/comment" \
            -H "Authorization: Basic $(echo -n ${JIRA_USER_EMAIL}:${JIRA_API_TOKEN} | base64)" \
            -H "Content-Type: application/json" \
            -d "{
              \"body\": {
                \"type\": \"doc\",
                \"version\": 1,
                \"content\": [
                  {
                    \"type\": \"paragraph\",
                    \"content\": [
                      {
                        \"type\": \"text\",
                        \"text\": \"ğŸš€ Netlify Deploy PreviewãŒåˆ©ç”¨å¯èƒ½ã§ã™\",
                        \"marks\": [{\"type\": \"strong\"}]
                      }
                    ]
                  },
                  {
                    \"type\": \"paragraph\",
                    \"content\": [
                      {
                        \"type\": \"text\",
                        \"text\": \"ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL: \"
                      },
                      {
                        \"type\": \"text\",
                        \"text\": \"${NETLIFY_URL}\",
                        \"marks\": [{
                          \"type\": \"link\",
                          \"attrs\": {\"href\": \"${NETLIFY_URL}\"}
                        }]
                      }
                    ]
                  },
                  {
                    \"type\": \"paragraph\",
                    \"content\": [
                      {
                        \"type\": \"text\",
                        \"text\": \"GitHub PR: \"
                      },
                      {
                        \"type\": \"text\",
                        \"text\": \"${PR_URL}\",
                        \"marks\": [{
                          \"type\": \"link\",
                          \"attrs\": {\"href\": \"${PR_URL}\"}
                        }]
                      }
                    ]
                  },
                  {
                    \"type\": \"paragraph\",
                    \"content\": [
                      {
                        \"type\": \"text\",
                        \"text\": \"å®Ÿè£…å†…å®¹ã‚’ç¢ºèªã—ã€å•é¡Œãªã‘ã‚Œã°PRã‚’ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚\"
                      }
                    ]
                  }
                ]
              }
            }"
          
          echo "Posted Deploy Preview URL to Jira ${JIRA_KEY}"
      
      - name: Comment on PR (No Jira Key)
        if: steps.extract-jira.outputs.result == 'null'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `â„¹ï¸ **Jiraèª²é¡Œã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ**

            PRã®ã‚¿ã‚¤ãƒˆãƒ«ã€æœ¬æ–‡ã€ã¾ãŸã¯ãƒ–ãƒ©ãƒ³ãƒåã«Jiraèª²é¡Œã‚­ãƒ¼ï¼ˆä¾‹: \`PROJ-123\`ï¼‰ã‚’å«ã‚ã‚‹ã¨ã€Netlify Deploy Previewã®URLãŒJiraã«è‡ªå‹•æŠ•ç¨¿ã•ã‚Œã¾ã™ã€‚`
            });
