name: Create GitHub Issue from Jira

on:
  repository_dispatch:
    types: [jira-issue-created]

permissions:
  issues: write

jobs:
  create-github-issue:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Create GitHub Issue from Jira
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload;
            const jiraKey = payload.issue_key;
            const jiraTitle = payload.issue_title;
            const jiraDescription = payload.issue_description || ''; // descriptionã¯çœç•¥å¯èƒ½
            const jiraUrl = payload.issue_url;
            const jiraType = payload.issue_type || 'Task';
            
            // GitHub Issueã‚’ä½œæˆ
            const issueBody = jiraDescription 
              ? `## ğŸ“‹ Jiraèª²é¡Œã‹ã‚‰è‡ªå‹•ä½œæˆ

            **Jira:** [${jiraKey}](${jiraUrl})
            **Type:** ${jiraType}

            ---

            ${jiraDescription}

            ---
            _ã“ã® Issue ã¯ Jira èª²é¡Œ ${jiraKey} ã‹ã‚‰è‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸ_`
              : `## ğŸ“‹ Jiraèª²é¡Œã‹ã‚‰è‡ªå‹•ä½œæˆ

            **Jira:** [${jiraKey}](${jiraUrl})
            **Type:** ${jiraType}

            è©³ç´°ã¯Jiraèª²é¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

            ---
            _ã“ã® Issue ã¯ Jira èª²é¡Œ ${jiraKey} ã‹ã‚‰è‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸ_`;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[${jiraKey}] ${jiraTitle}`,
              body: issueBody,
              labels: ['auto-implement', 'from-jira']
            });
            
            console.log(`Created GitHub Issue #${issue.data.number} for Jira ${jiraKey}`);
            
            // @Copilot ã‚’è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³ï¼ˆå¤§æ–‡å­—ã®Cï¼‰
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              assignees: ['Copilot']
            });
            
            console.log(`Assigned @copilot to Issue #${issue.data.number}`);
            
            // Jiraèª²é¡Œã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šJIRA_API_TOKENãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            if (process.env.JIRA_API_TOKEN && process.env.JIRA_BASE_URL && process.env.JIRA_USER_EMAIL) {
              const jiraComment = {
                body: `GitHub Issue ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸ: ${issue.data.html_url}\n\n@copilot ã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚`
              };
              
              try {
                const response = await fetch(`${process.env.JIRA_BASE_URL}/rest/api/3/issue/${jiraKey}/comment`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Basic ${Buffer.from(`${process.env.JIRA_USER_EMAIL}:${process.env.JIRA_API_TOKEN}`).toString('base64')}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(jiraComment)
                });
                
                if (response.ok) {
                  console.log(`Added comment to Jira ${jiraKey}`);
                }
              } catch (error) {
                console.log(`Failed to add comment to Jira: ${error.message}`);
              }
            }
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
